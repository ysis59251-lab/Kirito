<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnimeFume Admin</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:#0f172a;
  color:#fff;
  display:flex;
}
.sidebar{
  width:230px;
  background:#111827;
  padding:20px;
  height:100vh;
}
.sidebar h2{ color:#22d3ee; }
.main{
  flex:1;
  padding:20px;
  overflow-y:auto;
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:20px;
}
.card{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
}
.big{
  font-size:26px;
  font-weight:bold;
}
.panel{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
}
input{
  width:100%;
  padding:8px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
}
button{
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#22d3ee;
}
.delete-btn{
  background:#ff3b3b;
  color:#fff;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>üéõ Admin</h2>
</div>

<div class="main">

<!-- ===== CARDS ===== -->

<div class="cards">
  <div class="card">
    <div>üëÄ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
    <div class="big" id="onlineCount">0</div>
  </div>

  <div class="card">
    <div>üìà ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="big" id="totalViews">0</div>
  </div>

  <div class="card">
    <div>üé¨ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <div class="big" id="totalAnime">0</div>
  </div>
</div>

<!-- ===== ANIME MANAGE ===== -->

<div class="panel">
  <h3>üé¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</h3>

  <input id="animeId" placeholder="ID ‡πÄ‡∏ä‡πà‡∏ô naruto">
  <input id="animeTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
  <input id="animeImage" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
  <input id="animeDesc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">

  <button id="saveAnime">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>

  <hr style="margin:20px 0;border-color:#334155">

  <div id="animeManageList"></div>
</div>

<!-- ===== LIVE PREVIEW ===== -->

<div class="panel">
  <h3>üëÄ Live Preview ‡∏´‡∏ô‡πâ‡∏≤ Anime</h3>
  <button onclick="reloadAnime()">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</button>
  <div id="animeContainer" style="margin-top:15px;"></div>
</div>

</div>

<script type="module">

/* ===== FIREBASE ===== */

import { initializeApp } from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getDatabase,
  ref,
  onValue,
  set,
  remove
} from 
"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "PROJECT",
  storageBucket: "PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== STATS ===== */

onValue(ref(db,"stats/totalViews"), snap=>{
  totalViews.textContent = snap.exists() ? snap.val() : 0;
});

onValue(ref(db,"animeList"), snap=>{
  totalAnime.textContent =
    snap.exists() ? Object.keys(snap.val()).length : 0;
});

/* ===== ONLINE ===== */

onValue(ref(db,"onlineUsers"), snap=>{
  if(!snap.exists()){
    onlineCount.textContent = 0;
    return;
  }

  const data = snap.val();
  const now = Date.now();
  let count = 0;

  Object.entries(data).forEach(([key,val])=>{
    if(now - val.time > 60000){
      remove(ref(db,"onlineUsers/"+key));
    }else{
      count++;
    }
  });

  onlineCount.textContent = count;
});

/* ===== ANIME CMS ===== */

const manageBox = document.getElementById("animeManageList");

onValue(ref(db,"animeList"), snap=>{
  manageBox.innerHTML="";
  if(!snap.exists()) return;

  Object.entries(snap.val()).forEach(([id,data])=>{
    manageBox.innerHTML+=`
      <div style="background:#0f172a;padding:15px;border-radius:12px;margin-bottom:10px">
        <strong>${data.title}</strong>
        <div style="font-size:12px;color:#94a3b8">${id}</div>
        <div style="margin-top:8px">
          <button onclick="editAnime('${id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="delete-btn" onclick="deleteAnime('${id}')">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
  });
});

saveAnime.onclick=()=>{

  const id=animeId.value.trim();
  const title=animeTitle.value.trim();
  const image=animeImage.value.trim();
  const desc=animeDesc.value.trim();

  if(!id||!title) return alert("‡∏Å‡∏£‡∏≠‡∏Å ID ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á");

  set(ref(db,"animeList/"+id),{
    title,
    image,
    description:desc,
    createdAt:Date.now()
  });

  animeId.value="";
  animeTitle.value="";
  animeImage.value="";
  animeDesc.value="";
};

function deleteAnime(id){
  if(confirm("‡∏•‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")){
    remove(ref(db,"animeList/"+id));
  }
}
window.deleteAnime=deleteAnime;

function editAnime(id){

  onValue(ref(db,"animeList/"+id), snap=>{
    if(!snap.exists()) return;
    const data=snap.val();

    animeId.value=id;
    animeTitle.value=data.title;
    animeImage.value=data.image;
    animeDesc.value=data.description||"";
  },{
    onlyOnce:true
  });
}
window.editAnime=editAnime;

/* ===== LIVE PREVIEW ===== */

async function loadAnimePage(){
  const container=document.getElementById("animeContainer");
  const res=await fetch("/anime.html");
  container.innerHTML=await res.text();
}

function reloadAnime(){
  loadAnimePage();
}
window.reloadAnime=reloadAnime;

loadAnimePage();

</script>
</body>
</html>