<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>DarkFrame Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:sans-serif;
  background:url("https://img.freepik.com/free-photo/anime-night-sky-illustration_23-2151684372.jpg")
  center/cover no-repeat fixed;
  color:#fff;
}
.title{
  background:#fff;
  color:#000;
  padding:12px 16px;
  border-radius:12px;
  margin:12px;
  font-weight:700;
}
.top-title{
  background:rgba(0,0,0,.8);
  padding:12px;
  border-radius:12px;
  margin:12px;
  text-align:center;
}
.player{
  max-width:720px;
  margin:12px auto;
  background:#000;
  border-radius:14px;
  overflow:hidden;
}
.player iframe,
.player video{
  width:100%;
  aspect-ratio:16/9;
  border:none;
}
.controls{
  display:flex;
  gap:10px;
  margin:12px;
}
.btn{
  flex:1;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#1e1e1e;
  color:#fff;
}
.btn:hover{background:#ff4d4d}
</style>
</head>

<body>

<div class="title" id="titleText">กำลังโหลด…</div>
<div class="top-title" id="topText"></div>
<div class="player" id="player"></div>

<div class="controls">
  <button class="btn" onclick="prevEp()">⬅ ก่อนหน้า</button>
  <button class="btn" onclick="nextEp()">ถัดไป ➡</button>
</div>

<script>
/* ===== CONFIG ===== */
const SHEET_ID = "1r2QhYu826ZomrOOAOmAjsHfWv17aVmnBFylaeKnfsU8";
const SHEET_URL =
`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

/* ===== PARAM ===== */
const q = new URLSearchParams(location.search);
const anime = q.get("anime");
let ep = Number(q.get("ep") || 1);

if(!anime){
  document.body.innerHTML = "❌ ไม่พบ anime";
  throw "";
}

let list = [];

/* ===== LOAD SHEET ===== */
fetch(SHEET_URL)
.then(r=>r.text())
.then(t=>{
  const json = JSON.parse(t.substring(47).slice(0,-2));
  json.table.rows.forEach(r=>{
    if(r.c[0]?.v === anime){
      list.push({
        ep: Number(r.c[1]?.v),
        title: r.c[2]?.v || "",
        url: r.c[3]?.v || ""
      });
    }
  });
  list.sort((a,b)=>a.ep-b.ep);
  loadEp();
});

/* ===== LOAD EP ===== */
function loadEp(){
  const data = list.find(x=>x.ep===ep) || list[0];
  ep = data.ep;

  document.getElementById("titleText").innerText =
    `${anime} ตอนที่ ${ep} ${data.title}`;

  document.getElementById("topText").innerText =
    `ทั้งหมด ${list.length} ตอน`;

  play(data.url);
}

/* ===== PLAYER ===== */
function play(url){
  const p = document.getElementById("player");
  p.innerHTML = "";

  if(!url){
    p.innerText = "ยังไม่มีวิดีโอ";
    return;
  }

  // YouTube
  if(url.includes("youtube.com") || url.includes("youtu.be")){
    const id = url.split("v=")[1]?.split("&")[0] || url.split("/").pop();
    p.innerHTML =
      `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`;
  }

  // Google Drive
  else if(url.includes("drive.google")){
    const id = url.match(/\/d\/(.+?)\//)?.[1];
    p.innerHTML =
      `<iframe src="https://drive.google.com/file/d/${id}/preview" allowfullscreen></iframe>`;
  }

  // Video link
  else{
    p.innerHTML =
      `<video controls playsinline src="${url}"></video>`;
  }
}

/* ===== NAV ===== */
function prevEp(){
  const i=list.findIndex(x=>x.ep===ep);
  if(i>0)
    location.search=`?anime=${anime}&ep=${list[i-1].ep}`;
}
function nextEp(){
  const i=list.findIndex(x=>x.ep===ep);
  if(i<list.length-1)
    location.search=`?anime=${anime}&ep=${list[i+1].ep}`;
}
</script>

</body>
</html>