<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnimeFume Admin</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:#0f172a;
  color:#fff;
  display:flex;
}
.sidebar{
  width:230px;
  background:#111827;
  padding:20px;
  height:100vh;
}
.sidebar h2{ color:#22d3ee; }
.main{
  flex:1;
  padding:20px;
  overflow-y:auto;
}
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:20px;
}
.card{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
}
.big{
  font-size:26px;
  font-weight:bold;
}
.panel{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
}
.spam-box{
  background:#300;
  padding:15px;
  border-radius:12px;
  margin-bottom:20px;
  color:#ff4d4d;
}
button{
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#22d3ee;
}
.clear-btn{
  background:#ff3b3b;
  color:#fff;
  margin-top:10px;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>üéõ Admin</h2>
</div>

<div class="main">

<div class="cards">
  <div class="card">
    <div>üëÄ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
    <div class="big" id="onlineCount">0</div>
  </div>

  <div class="card">
    <div>üìà ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="big" id="totalViews">0</div>
  </div>

  <div class="card">
    <div>üé¨ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <div class="big" id="totalAnime">0</div>
  </div>
</div>

<div class="panel">
  <h3>üìä ‡∏ß‡∏¥‡∏ß‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
  <canvas id="viewChart" height="100"></canvas>
</div>

<div class="panel">
  <h3>üé¨ Live Preview ‡∏´‡∏ô‡πâ‡∏≤ Anime</h3>
  <button onclick="reloadAnime()">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</button>
  <div id="animeContainer" style="margin-top:15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
</div>

<div class="spam-box">
  <h3>‚ö† ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡πâ‡∏°</h3>
  <div id="spamCount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <div id="spamUsers"></div>
  <button class="clear-btn" id="clearSpam">‡∏•‡πâ‡∏≤‡∏á Spam</button>
</div>

</div>

<script type="module">

/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase,
  ref,
  onValue,
  remove
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "PROJECT",
  storageBucket: "PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= ONLINE USERS ================= */

onValue(ref(db,"onlineUsers"), snap=>{
  if(!snap.exists()){
    onlineCount.textContent = 0;
    return;
  }

  const data = snap.val();
  const now = Date.now();
  let count = 0;

  Object.entries(data).forEach(([key,val])=>{
    if(now - val.time > 60000){
      remove(ref(db,"onlineUsers/"+key));
    }else{
      count++;
    }
  });

  onlineCount.textContent = count;
});

/* ================= TOTAL VIEWS ================= */

onValue(ref(db,"stats/totalViews"), snap=>{
  totalViews.textContent = snap.exists() ? snap.val() : 0;
});

/* ================= TOTAL ANIME ================= */

onValue(ref(db,"animeList"), snap=>{
  totalAnime.textContent =
    snap.exists() ? Object.keys(snap.val()).length : 0;
});

/* ================= CHART ================= */

const ctx = document.getElementById("viewChart");
let chart = new Chart(ctx,{
  type:"line",
  data:{
    labels:[],
    datasets:[{
      label:"‡∏ß‡∏¥‡∏ß‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
      data:[],
      borderColor:"#22d3ee",
      fill:false
    }]
  }
});

onValue(ref(db,"stats/daily"), snap=>{
  if(!snap.exists()) return;
  chart.data.labels = Object.keys(snap.val());
  chart.data.datasets[0].data = Object.values(snap.val());
  chart.update();
});

/* ================= SPAM SYSTEM ================= */

onValue(ref(db,"security/spamCount"), snap=>{
  spamCount.textContent =
    "‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢: "+(snap.val()||0)+" ‡∏Ñ‡∏ô";
});

onValue(ref(db,"security/spamUsers"), snap=>{
  spamUsers.innerHTML = "";
  if(!snap.exists()) return;

  Object.entries(snap.val()).forEach(([id,data])=>{
    const time = new Date(data.time).toLocaleString();
    spamUsers.innerHTML += `
      <div style="font-size:13px;margin-bottom:6px;">
        üß® ${id}<br>
        <span style="color:#94a3b8">${time}</span>
      </div>
    `;
  });
});

clearSpam.onclick = ()=>{
  if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Spam ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    remove(ref(db,"security"));
  }
};

/* ================= LOAD ANIME PAGE ================= */

let animeLoaded = false;

async function loadAnimePage(){

  const container = document.getElementById("animeContainer");

  container.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

  try{
    const res = await fetch("‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î.html");
    const html = await res.text();

    container.innerHTML = html;

    container.querySelectorAll("script").forEach(oldScript=>{
      const newScript = document.createElement("script");

      if(oldScript.src){
        newScript.src = oldScript.src;
      }else{
        newScript.textContent = oldScript.textContent;
      }

      if(oldScript.type){
        newScript.type = oldScript.type;
      }

      document.body.appendChild(newScript);
      oldScript.remove();
    });

    animeLoaded = true;

  }catch(err){
    container.innerHTML = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  }
}

function reloadAnime(){
  animeLoaded = false;
  loadAnimePage();
}

window.reloadAnime = reloadAnime;

loadAnimePage();

</script>
</body>
</html>