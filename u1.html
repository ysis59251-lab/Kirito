<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>DarkFrame Watch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden; /* สำคัญมาก กันล้น */
}

.bg-video{
  position:fixed;
  top:50%;
  left:50%;
  width:100vw;
  height:100vh;
  object-fit:cover;
  transform:translate(-50%, -50%);
  z-index:-1;
  background:#000; /* กันจอดำกระพริบ */
}
  background:url("https://img.freepik.com/free-photo/anime-night-sky-illustration_23-2151684372.jpg")
  center/cover no-repeat fixed;
  color:#fff;
}
.title{
  background:#fff;
  color:#000;
  padding:12px 16px;
  border-radius:12px;
  margin:12px;
  font-weight:700;
}
.top-title{
  background:rgba(0,0,0,.8);
  padding:12px;
  border-radius:12px;
  margin:12px;
  text-align:center;
}
.player{
  max-width:720px;
  margin:12px auto;
  background:#000;
  border-radius:14px;
  overflow:hidden;
}
.player iframe,
.player video{
  width:100%;
  aspect-ratio:16/9;
  border:none;
}
.controls{
  display:flex;
  gap:10px;
  margin:12px;
}
.btn{
  flex:1;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#1e1e1e;
  color:#fff;
}
.btn:hover{background:#ff4d4d}
</style>
</head>

<body>

<div class="title" id="titleText">กำลังโหลด…</div>
<div class="top-title" id="topText"></div>
<div class="player" id="player"></div>

<div class="controls">
  <button class="btn" onclick="prevEp()">⬅ ก่อนหน้า</button>
  <button class="btn" onclick="nextEp()">ถัดไป ➡</button>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1r2QhYu826ZomrOOAOmAjsHfWv17aVmnBFylaeKnfsU8";
const SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

/* ================= PARAM ================= */
const params = new URLSearchParams(location.search);
let anime = params.get("anime");
let ep = Number(params.get("ep") || 1);

let episodes = [];

/* ================= LOAD SHEET ================= */
fetch(SHEET_URL)
.then(r => r.text())
.then(t => {
  const json = JSON.parse(t.substring(47).slice(0, -2));
  const rows = json.table.rows;

  if (!anime && rows.length) {
    anime = rows[0].c[0]?.v;
  }

  rows.forEach(r => {
    if (r.c[0]?.v === anime) {
      episodes.push({
        ep: Number(r.c[1]?.v),
        title: r.c[2]?.v || "",
        url: r.c[3]?.v || ""
      });
    }
  });

  episodes.sort((a,b)=>a.ep-b.ep);
  init();
});

/* ================= INIT ================= */
function init(){
  const player = document.getElementById("player");

  if(!episodes.length){
    player.innerText = "ไม่พบข้อมูลตอน";
    return;
  }

  const current = episodes.find(e=>e.ep === ep) || episodes[0];
  ep = current.ep;

  document.getElementById("titleText").innerText =
    `${anime} ตอนที่ ${ep}`;

  document.getElementById("topText").innerText =
    `รวมทั้งหมด ${episodes.length} ตอน`;

  showVideo(current.url);
}

/* ================= VIDEO ================= */
function showVideo(url){
  const area = document.getElementById("player");
  area.innerHTML = "";

  if(!url){
    area.innerText = "ยังไม่มีวิดีโอ";
    return;
  }

  // YouTube
  if(url.includes("youtube")){
    const id = url.split("v=")[1]?.split("&")[0];
    area.innerHTML =
      `<iframe src="https://www.youtube.com/embed/${id}"
       allowfullscreen></iframe>`;
  }
  // Google Drive
  else if(url.includes("drive.google")){
    area.innerHTML =
      `<iframe src="${url}" allowfullscreen></iframe>`;
  }
  // mp4 / m3u8
  else{
    area.innerHTML =
      `<video controls playsinline src="${url}"></video>`;
    const v = area.querySelector("video");
    if(v) v.onended = nextEp;
  }
}

/* ================= NAV ================= */
function prevEp(){
  const i = episodes.findIndex(e=>e.ep === ep);
  if(i > 0){
    location.search =
      `?anime=${encodeURIComponent(anime)}&ep=${episodes[i-1].ep}`;
  }
}

function nextEp(){
  const i = episodes.findIndex(e=>e.ep === ep);
  if(i < episodes.length-1){
    location.search =
      `?anime=${encodeURIComponent(anime)}&ep=${episodes[i+1].ep}`;
  }
}
</script>

</body>
</html>