<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anime Admin Dashboard</title>

<style>
body{
  margin:0;
  background:#0f0f0f;
  color:#fff;
  font-family:system-ui;
}
header{
  padding:15px;
  background:#111;
  font-size:20px;
  font-weight:bold;
}
.container{
  padding:20px;
}
.card{
  background:#1b1b1b;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
}
button{
  padding:6px 10px;
  border:none;
  cursor:pointer;
  border-radius:5px;
  margin-left:5px;
  color:#fff;
}
input{
  padding:8px;
  width:100%;
  max-width:400px;
  border-radius:6px;
  border:none;
}
.anime-item{
  display:flex;
  justify-content:space-between;
  background:#222;
  padding:8px;
  margin-bottom:5px;
  border-radius:6px;
}

/* ===== Top Right Inbox Button ===== */
.topbar{
  position:fixed;
  top:15px;
  right:20px;
  z-index:999;
}
.inbox-btn{
  background:#222;
  padding:10px 15px;
  border-radius:30px;
  cursor:pointer;
  position:relative;
}
.inbox-badge{
  position:absolute;
  top:-5px;
  right:-5px;
  background:red;
  color:#fff;
  border-radius:50%;
  padding:3px 7px;
  font-size:12px;
}

/* ===== Slide Panel ===== */
.inbox-panel{
  position:fixed;
  top:0;
  right:-350px;
  width:350px;
  height:100%;
  background:#111;
  padding:20px;
  overflow-y:auto;
  transition:0.3s;
  z-index:998;
}
.inbox-panel.active{
  right:0;
}
.message-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#222;
  padding:8px;
  margin-bottom:6px;
  border-radius:6px;
}
.message-actions{
  display:flex;
  gap:5px;
}
.btn-view{ background:#2196f3; }
.btn-delete{ background:#ff3c3c; }
.btn-ban{ background:#9c27b0; }
</style>
</head>
<body>

<header>üî• Anime Admin Dashboard</header>

<!-- üîù ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô -->
<div class="topbar">
  <div class="inbox-btn" onclick="toggleReportPanel()">
    üö®
    <span id="reportUnread" class="inbox-badge">0</span>
  </div>
</div>

<!-- Slide Panel ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ -->
<div id="reportPanel" class="inbox-panel">
  <h3>üö® ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏°</h3>
  <div id="reportList"></div>
</div>

<div class="container">

<div class="card">
  üë• ‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: <span id="onlineCount">0</span>
</div>

<div class="card">
  <h3>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</h3>
  <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." oninput="searchAnime()">
</div>

<div class="card">
  <h3>üé¨ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏∞</h3>
  <div id="animeList"></div>
</div>

<div class="card">
  <h3>üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</h3>
  <div id="ranking"></div>
</div>

</div>

<audio id="notifySound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getDatabase, ref, set, onValue, remove, update, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* üî• Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyC1S1BToUhVmWqyeTWbHlPdI8hY0aGKNDg",
  authDomain: "darkframe300.firebaseapp.com",
  databaseURL: "https://darkframe300-default-rtdb.firebaseio.com",
  projectId: "darkframe300",
  appId: "1:296568248360:web:7867a60675ce32e3d6bd1d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= ONLINE USERS ================= */

const userId = "admin_" + Math.random().toString(36).substr(2,9);
const onlineRef = ref(db, "onlineUsers/" + userId);

set(onlineRef, true);
onDisconnect(onlineRef).remove();

onValue(ref(db, "onlineUsers"), (snap)=>{
  document.getElementById("onlineCount").innerText =
    snap.exists() ? Object.keys(snap.val()).length : 0;
});

/* ================= LOAD & SEARCH ANIME ================= */

let allAnime = [];

onValue(ref(db, "anime"), (snap)=>{
  allAnime = [];

  if(!snap.exists()){
    document.getElementById("animeList").innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    return;
  }

  snap.forEach(child=>{
    allAnime.push({
      id: child.key,
      ...child.val()
    });
  });

  renderAnime(allAnime);
  renderRanking(allAnime);
});

function renderAnime(list){
  const container = document.getElementById("animeList");
  container.innerHTML = "";

  list.forEach(data=>{
    container.innerHTML += `
      <div class="anime-item">
        ${data.title} (${data.status || "active"})
        <div>
          <button style="background:#ff9800"
            onclick="disableAnime('${data.id}')">‡∏õ‡∏¥‡∏î</button>
          <button style="background:#ff3c3c"
            onclick="deleteAnime('${data.id}')">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
  });
}

window.searchAnime = function(){
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const filtered = allAnime.filter(a =>
    a.title?.toLowerCase().includes(keyword)
  );
  renderAnime(filtered);
};

window.disableAnime = function(id){
  update(ref(db, "anime/"+id), {status:"disabled"});
};

window.deleteAnime = function(id){
  if(confirm("‡∏•‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")){
    remove(ref(db, "anime/"+id));
  }
};

/* ================= RANKING ================= */

function renderRanking(arr){
  const sorted = [...arr].sort((a,b)=>
    (b.views||0)-(a.views||0)
  );

  const container = document.getElementById("ranking");
  container.innerHTML="";

  sorted.slice(0,5).forEach((anime,i)=>{
    container.innerHTML += `
      <div class="anime-item">
        #${i+1} ${anime.title} (${anime.views||0} views)
      </div>
    `;
  });
}

/* ================= REPORT SYSTEM ================= */

window.toggleReportPanel = function(){
  document.getElementById("reportPanel").classList.toggle("active");
};

let lastReportCount = 0;

onValue(ref(db,"reports"),(snapshot)=>{

  const container = document.getElementById("reportList");
  const badge = document.getElementById("reportUnread");

  container.innerHTML = "";

  if(!snapshot.exists()){
    container.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô";
    badge.innerText = 0;
    return;
  }

  let unread = 0;
  let count = 0;

  const reports = [];

  snapshot.forEach(child=>{
    reports.push({
      id: child.key,
      ...child.val()
    });
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
  reports.reverse();

  reports.forEach(data=>{

    count++;
    if(!data.read) unread++;

    const div = document.createElement("div");
    div.className = "message-item";

    div.innerHTML = `
      <div>
        <b>${data.page || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏´‡∏ô‡πâ‡∏≤"}</b>
        ${data.read ? "‚úÖ" : "üÜï"}<br>
        <small>${new Date(data.time).toLocaleString()}</small>
      </div>
      <div class="message-actions">
        <button class="btn-view">‡πÄ‡∏õ‡∏¥‡∏î</button>
        <button class="btn-delete">‡∏•‡∏ö</button>
      </div>
    `;

    div.querySelector(".btn-view").onclick = () => {
      alert(
        "‡∏´‡∏ô‡πâ‡∏≤: "+data.page+
        "\n\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:\n"+data.detail+
        "\n\n‡πÄ‡∏ß‡∏•‡∏≤: "+new Date(data.time).toLocaleString()
      );

      update(ref(db,"reports/"+data.id),{read:true});
    };

    div.querySelector(".btn-delete").onclick = () => {
      if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")){
        remove(ref(db,"reports/"+data.id));
      }
    };

    container.appendChild(div);
  });

  badge.innerText = unread;

  if(count > lastReportCount){
    document.getElementById("notifySound").play().catch(()=>{});
  }

  lastReportCount = count;
});

</script>

</body>
</html>