<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anime Admin Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI, sans-serif;
  background:#0f172a;
  color:#fff;
  display:flex;
}

/* SIDEBAR */
.sidebar{
  width:230px;
  background:#111827;
  padding:20px;
  height:100vh;
}
.sidebar h2{
  color:#22d3ee;
}
.sidebar a{
  display:block;
  color:#94a3b8;
  margin:15px 0;
  text-decoration:none;
}

/* MAIN */
.main{
  flex:1;
  padding:20px;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:20px;
}

.card{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
}

.big{
  font-size:26px;
  font-weight:bold;
}

.panel{
  background:#1e293b;
  padding:20px;
  border-radius:16px;
  margin-bottom:20px;
}

/* TOP 10 */
.top-item{
  display:flex;
  gap:12px;
  padding:12px 0;
  border-bottom:1px solid #334155;
  align-items:center;
}

.rank{
  font-size:20px;
  width:30px;
  text-align:center;
}

.cover{
  width:50px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
}

.progress{
  height:6px;
  background:#334155;
  border-radius:6px;
  overflow:hidden;
  margin-top:6px;
}

.progress div{
  height:100%;
  background:#22d3ee;
  width:0%;
}
select{
  padding:6px;
  border-radius:8px;
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>üéõ Admin</h2>
  <a href="#">Dashboard</a>
</div>

<div class="main">

<!-- CARDS -->
<div class="cards">
  <div class="card">
    <div>üëÄ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
    <div class="big" id="onlineCount">0</div>
  </div>

  <div class="card">
    <div>üìà ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="big" id="totalViews">0</div>
  </div>

  <div class="card">
    <div>üé¨ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    <div class="big" id="totalAnime">0</div>
  </div>
</div>

<!-- CHART -->
<div class="panel">
  <h3>üìä ‡∏ß‡∏¥‡∏ß‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
  <canvas id="viewChart" height="100"></canvas>
</div>

<!-- TOP 10 -->
<div class="panel">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3>üèÜ Top 10</h3>
    <select id="rangeSelect">
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
      <option value="30">30 ‡∏ß‡∏±‡∏ô</option>
    </select>
  </div>
  <div id="topList"></div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const topList=document.getElementById("topList");
const rangeSelect=document.getElementById("rangeSelect");

let animeData={};

async function loadAnime(){
  const snap=await get(ref(db,"animeList"));
  if(snap.exists()) animeData=snap.val();
}
await loadAnime();

function getPath(){
  if(rangeSelect.value==="7") return "stats/last7";
  if(rangeSelect.value==="30") return "stats/last30";
  return "animeViews";
}

function medal(i){
  if(i===0) return "ü•á";
  if(i===1) return "ü•à";
  if(i===2) return "ü•â";
  return "#"+(i+1);
}

function renderTop(data){

  const arr=Object.entries(data||{});
  arr.sort((a,b)=>b[1]-a[1]);
  const top10=arr.slice(0,10);
  const max=top10[0]?top10[0][1]:1;

  topList.innerHTML="";

  top10.forEach(([id,views],i)=>{

    if(!animeData[id]) return;

    const percent=(views/max)*100;

    topList.innerHTML+=`
      <div class="top-item">
        <div class="rank">${medal(i)}</div>
        <img src="${animeData[id].cover}" class="cover">
        <div style="flex:1">
          <div style="font-weight:bold">${animeData[id].title}</div>
          <div style="font-size:13px;color:#94a3b8">${views} ‡∏ß‡∏¥‡∏ß</div>
          <div class="progress">
            <div style="width:${percent}%"></div>
          </div>
        </div>
      </div>
    `;
  });

  document.getElementById("totalViews").textContent=
    arr.reduce((s,a)=>s+a[1],0);

  document.getElementById("totalAnime").textContent=arr.length;
}

function loadViews(){
  onValue(ref(db,getPath()),snap=>{
    if(snap.exists()) renderTop(snap.val());
  });
}

rangeSelect.addEventListener("change",loadViews);

loadViews();

/* ONLINE */
onValue(ref(db,"onlineUsers"),snap=>{
  document.getElementById("onlineCount").textContent=
    snap.exists()?Object.keys(snap.val()).length:0;
});

/* CHART */
let chart;
onValue(ref(db,"animeViews"),snap=>{
  if(!snap.exists()) return;

  const data=snap.val();
  const labels=Object.keys(data);
  const values=Object.values(data);

  if(chart) chart.destroy();

  chart=new Chart(document.getElementById("viewChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        label:"‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        data:values,
        backgroundColor:"#22d3ee"
      }]
    }
  });
});

</script>

</body>
</html>