<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AnimeFume Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

.report-card{
  background:#111;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
  border-left:4px solid #ff3b3b;
}

.report-card.read{
  opacity:.6;
  border-left-color:#555;
}

.report-card small{
  color:#aaa;
  font-size:12px;
}

.report-card button{
  margin-top:6px;
  padding:6px 10px;
  border:none;
  border-radius:8px;
  background:#ff3b3b;
  color:#fff;
  font-size:12px;
  cursor:pointer;
}


body{background:#0b0b0b;color:#fff;font-family:system-ui;padding:16px}
h2{color:#00ffcc}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.card{background:#111;padding:14px;border-radius:12px;border:1px solid #222}
.section{margin-top:20px;background:#111;padding:16px;border-radius:14px;border:1px solid #222}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #222;padding:8px;text-align:center}
th{color:#00ffcc}
.progress{height:8px;background:#222;border-radius:10px;margin-top:4px}
.bar{height:100%;background:linear-gradient(90deg,#00ffcc,#00cfa8)}
canvas{max-height:320px}
</style>
</head>

<body>
<!-- MAIL ICON -->
<div id="mailBox" onclick="toggleInbox()">
  üì¢
  <span id="mailCount">0</span>
</div>

<!-- INBOX -->
<div id="inbox">
  <h3>üì¨ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
  <div id="reportList"></div>
</div>

<h2>üìä AnimeFume Dashboard</h2>

<!-- ===== FIREBASE STATS ===== -->
<div class="cards">
  <div class="card">üë• ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå<br><b id="online">0</b></div>
  <div class="card">üëÅÔ∏è ‡∏¢‡∏≠‡∏î‡∏î‡∏π‡∏£‡∏ß‡∏°<br><b id="views">0</b></div>
  <div class="card">üìö ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br><b id="aCount">0</b></div>
  <div class="card">üé¨ ‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br><b id="eTotal">0</b></div>
  <div class="card">‚úÖ ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß<br><b id="eDone">0</b></div>
  <div class="card">‚è≥ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠<br><b id="eWait">0</b></div>
</div>

<!-- ===== GRAPHS ===== -->
<div class="section">
  <canvas id="dailyChart"></canvas>
</div>

<div class="section">
  <canvas id="pieChart"></canvas>
</div>

<!-- ===== TABLE ===== -->
<div class="section">
<table>
<thead>
<tr>
<th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß</th><th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>%</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<!-- ===== SCRIPTS ===== -->
<script src="firebase.js"></script>
<script>

const reportList = document.getElementById("reportList");

function renderReports(){
  const reports = JSON.parse(localStorage.getItem("reports") || "[]");

  if(reports.length === 0){
    reportList.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</p>";
    return;
  }

  reportList.innerHTML = reports.map((r,i)=>`
    <div class="report-card ${r.read ? "read" : ""}">
      <small>üïí ${r.time}</small><br>
      <small>üìÑ ${r.page}</small>
      <p>${r.detail}</p>
      ${!r.read ? `<button onclick="markRead(${i})">‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>` : ""}
    </div>
  `).reverse().join("");
}

function markRead(index){
  const reports = JSON.parse(localStorage.getItem("reports"));
  reports[index].read = true;
  localStorage.setItem("reports", JSON.stringify(reports));
  renderReports();
}

renderReports();

/* ================= FIREBASE ================= */

// ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
db.ref("onlineUsers").on("value", s=>{
  online.textContent = s.numChildren();
});

// ‡∏¢‡∏≠‡∏î‡∏î‡∏π‡∏£‡∏ß‡∏°
db.ref("views/total").on("value", s=>{
  views.textContent = s.val() || 0;
});

// ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
let dailyChart;
db.ref("daily").on("value", snap=>{
  const labels=[], data=[];
  snap.forEach(d=>{
    labels.push(d.key);
    data.push(d.val());
  });

  if(dailyChart) dailyChart.destroy();
  dailyChart = new Chart(dailyChartCanvas,{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
        data,
        borderColor:"#00ffcc",
        tension:.3
      }]
    }
  });
});

const dailyChartCanvas = document.getElementById("dailyChart");

/* ================= EPISODES.JSON ================= */

let pie;

async function loadEpisodes(){
  const res = await fetch("episodes.json?ts="+Date.now());
  const data = await res.json();

  let total=0, done=0;
  list.innerHTML="";

  data.anime.forEach(a=>{
    total+=a.total;
    done+=a.episodes;
    const p=Math.round(a.episodes/a.total*100);

    list.innerHTML+=`
    <tr>
      <td>${a.title}</td>
      <td>${a.total}</td>
      <td>${a.episodes}</td>
      <td>${a.total-a.episodes}</td>
      <td>${p}%
        <div class="progress">
          <div class="bar" style="width:${p}%"></div>
        </div>
      </td>
    </tr>`;
  });

  aCount.textContent=data.anime.length;
  eTotal.textContent=total;
  eDone.textContent=done;
  eWait.textContent=total-done;

  if(pie) pie.destroy();
  pie = new Chart(pieChart,{
    type:"doughnut",
    data:{
      labels:["‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß","‡πÄ‡∏´‡∏•‡∏∑‡∏≠"],
      datasets:[{
        data:[done,total-done],
        backgroundColor:["#00ffcc","#333"]
      }]
    }
  });
}

const pieChart = document.getElementById("pieChart");
loadEpisodes();
setInterval(loadEpisodes,5000);
</script>

</body>
</html>